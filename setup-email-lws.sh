#!/bin/bash

# Setup script for LWS Email Integration
# Quick setup for Mobutu Zemanga website email templates

echo "=========================================="
echo "üöÄ Configuration Email LWS"
echo "=========================================="
echo ""

# Check if .env.local already exists
if [ -f .env.local ]; then
    echo "‚ö†Ô∏è  Le fichier .env.local existe d√©j√†."
    read -p "Voulez-vous le remplacer? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Installation annul√©e."
        exit 1
    fi
fi

echo "üì¶ Installation des d√©pendances..."
npm install nodemailer @react-email/render
npm install --save-dev @types/nodemailer

echo ""
echo "üìù Configuration des identifiants SMTP..."
echo ""

# Prompt for SMTP credentials
read -p "Entrez votre email LWS (d√©faut: info@mobutuzemanga.com): " smtp_user
smtp_user=${smtp_user:-info@mobutuzemanga.com}

read -sp "Entrez le mot de passe de votre email: " smtp_password
echo ""

read -p "Entrez l'h√¥te SMTP (d√©faut: smtp.lws.fr): " smtp_host
smtp_host=${smtp_host:-smtp.lws.fr}

read -p "Entrez le port SMTP (d√©faut: 587): " smtp_port
smtp_port=${smtp_port:-587}

# Create .env.local file
cat > .env.local << EOF
# LWS SMTP Configuration
# Generated by setup-email-lws.sh

SMTP_HOST=$smtp_host
SMTP_PORT=$smtp_port
SMTP_USER=$smtp_user
SMTP_PASSWORD=$smtp_password

# Site Configuration
NEXT_PUBLIC_SITE_URL=https://mobutuzemanga.com
CONTACT_EMAIL=info@mobutuzemanga.com
EOF

echo ""
echo "‚úÖ Fichier .env.local cr√©√© avec succ√®s!"
echo ""

# Check if route.ts needs to be updated
if grep -q "TEMPORARY PLACEHOLDER" app/api/contact/route.ts; then
    echo "‚ö†Ô∏è  L'API route n'est pas encore activ√©e."
    echo ""
    echo "Pour activer l'envoi d'emails:"
    echo "1. Ouvrez: app/api/contact/route.ts"
    echo "2. D√©commentez la section 'METHOD 4: Using LWS SMTP'"
    echo "3. Commentez ou supprimez la section 'TEMPORARY PLACEHOLDER'"
    echo ""
    read -p "Voulez-vous ouvrir le fichier maintenant? (y/N): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        ${EDITOR:-nano} app/api/contact/route.ts
    fi
else
    echo "‚úÖ L'API route semble d√©j√† configur√©e."
fi

echo ""
echo "=========================================="
echo "‚ú® Installation termin√©e!"
echo "=========================================="
echo ""
echo "Prochaines √©tapes:"
echo "1. Red√©marrez le serveur: npm run dev"
echo "2. Testez le formulaire de contact"
echo "3. V√©rifiez vos emails"
echo ""
echo "üìö Documentation compl√®te:"
echo "   - components/email/LWS_SETUP.md"
echo "   - components/email/README.md"
echo ""
echo "üîí S√©curit√©: Le fichier .env.local est automatiquement ignor√© par git"
echo ""

# Check if server is running
if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1 ; then
    echo "‚ö†Ô∏è  Le serveur est en cours d'ex√©cution sur le port 3000."
    echo "   Red√©marrez-le pour appliquer les changements."
fi

echo ""
echo "‚úÖ Configuration termin√©e avec succ√®s!"
